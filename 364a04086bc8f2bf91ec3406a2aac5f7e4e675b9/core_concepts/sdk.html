<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Linera SDK - Linera Developer Documentation</title>


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="../custom.css">

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="../overview.html"><strong aria-hidden="true">2.</strong> Overview</a></li><li class="chapter-item expanded "><a href="../getting_started.html"><strong aria-hidden="true">3.</strong> Getting started</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../getting_started/installation.html"><strong aria-hidden="true">3.1.</strong> Installation</a></li><li class="chapter-item expanded "><a href="../getting_started/first_app.html"><strong aria-hidden="true">3.2.</strong> Your First App</a></li></ol></li><li class="chapter-item expanded "><a href="../core_concepts.html"><strong aria-hidden="true">4.</strong> Core Concepts</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../core_concepts/micro_chains.html"><strong aria-hidden="true">4.1.</strong> Microchains</a></li><li class="chapter-item expanded "><a href="../core_concepts/wallet.html"><strong aria-hidden="true">4.2.</strong> The Wallet</a></li><li class="chapter-item expanded "><a href="../core_concepts/validators.html"><strong aria-hidden="true">4.3.</strong> Validators</a></li><li class="chapter-item expanded "><a href="../core_concepts/applications.html"><strong aria-hidden="true">4.4.</strong> Applications</a></li><li class="chapter-item expanded "><a href="../core_concepts/sdk.html" class="active"><strong aria-hidden="true">4.5.</strong> Linera SDK</a></li></ol></li><li class="chapter-item expanded "><a href="../advanced.html"><strong aria-hidden="true">5.</strong> Advanced Topics</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../advanced_topics/execution_model.html"><strong aria-hidden="true">5.1.</strong> Execution Model</a></li><li class="chapter-item expanded "><a href="../advanced_topics/views.html"><strong aria-hidden="true">5.2.</strong> Views</a></li><li class="chapter-item expanded "><a href="../advanced_topics/block_creation.html"><strong aria-hidden="true">5.3.</strong> Creating New Blocks</a></li></ol></li><li class="chapter-item expanded "><a href="../examples.html"><strong aria-hidden="true">6.</strong> Examples</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../examples/hello_world.html"><strong aria-hidden="true">6.1.</strong> Hello World</a></li></ol></li><li class="chapter-item expanded "><a href="../glossary.html"><strong aria-hidden="true">7.</strong> Glossary</a></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Linera Developer Documentation</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="linera-sdk"><a class="header" href="#linera-sdk">Linera SDK</a></h1>
<p>In this section we'll be exploring the Linera SDK by building a simple counter application.</p>
<p>This is going to cover most facets of building an app, with the notable exception of the front-end
which is covered in a future section.</p>
<h2 id="linera-sdk-crate"><a class="header" href="#linera-sdk-crate">Linera SDK Crate</a></h2>
<p>The <code>linera-sdk</code> crate exposes the basic traits required to create a Linera
application.</p>
<p>This section takes you over the steps to create a full Web 3 application with a
Linera application for the back end and a React front end.</p>
<h2 id="creating-your-linera-project"><a class="header" href="#creating-your-linera-project">Creating your Linera Project</a></h2>
<p>To create your Linera project, use the <code>linera project init</code> command to setup
the scaffolding and requisite files:</p>
<pre><code class="language-bash">./linera project new ../../linera-examples/my-counter
</code></pre>
<p><code>linera project init</code> bootstraps your project by creating the following key files:</p>
<ul>
<li><code>Cargo.toml</code>: your project's manifest filled with the necessary dependencies to create an app</li>
<li><code>state.rs</code>: the file which holds your application's state</li>
<li><code>contract.rs</code>: the file which holds your application's contract, and the binary target for the contract bytecode</li>
<li><code>service.rs</code>: the file which holds your application's service, and the binary contract for the service bytecode</li>
</ul>
<h2 id="creating-the-state"><a class="header" href="#creating-the-state">Creating the State</a></h2>
<p>The <code>struct</code> which defines your application's state can be found in <code>state.rs</code>.</p>
<p>To represent our Counter, all we're going to need a single <code>u128</code>. To persist
the counter we'll be using Linera's <a href="../advanced_topics/views.html">view</a> paradigm.</p>
<p>Views are a little like an <a href="https://en.wikipedia.org/wiki/Object%E2%80%93relational_mapping">ORM</a>,
however instead of mapping your datastructures to a relational database like Postgres, they are
instead mapped onto key-value stores like <a href="https://rocksdb.org/">RocksDB</a>.</p>
<p>In vanilla Rust, we might represent our Counter as so:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct Counter {
  value: u128
}
<span class="boring">}</span></code></pre></pre>
<p>However to persist your data, you'll need to replace the existing <code>State</code> struct in `state.rs
with the following view:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// The application state.
#[derive(RootView, Debug)]
pub struct Counter&lt;C&gt; {
    pub value: RegisterView&lt;C, u128&gt;,
}
<span class="boring">}</span></code></pre></pre>
<p>The <code>RegisterView</code> supports modifying a single value of type <code>T</code>. There are different types of
views for different use-cases, but the majority of common data structures have already been implemented:</p>
<ul>
<li>A <code>Vec</code> maps to a <code>CollectionView</code></li>
<li>A <code>HashMap</code> maps to a <code>MapView</code></li>
<li>A <code>Queue</code> maps to a <code>QueueView</code></li>
</ul>
<p>For an exhaustive list refer to the Views <a href="TODO">documentation</a>.</p>
<h2 id="creating-the-contract"><a class="header" href="#creating-the-contract">Creating the Contract</a></h2>
<p>The <code>Contract</code> is the first component of your Linera application. It can
actually change the state of the application.</p>
<p>To create a contract, we need to implement the <code>Contract</code> trait, which is
as follows:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[async_trait]
pub trait Contract: Sized {
    /// Message reports for application execution errors.
    type Error: Error;
    /// The desired storage backend to use to store the application's state.
    type Storage;

    /// Initializes the application on the chain that created it.
    async fn initialize(
        &amp;mut self,
        context: &amp;OperationContext,
        argument: &amp;[u8],
    ) -&gt; Result&lt;ExecutionResult, Self::Error&gt;;

    /// Applies an operation from the current block.
    async fn execute_operation(
        &amp;mut self,
        context: &amp;OperationContext,
        operation: &amp;[u8],
    ) -&gt; Result&lt;ExecutionResult, Self::Error&gt;;

    /// Applies an effect originating from a cross-chain message.
    async fn execute_effect(
        &amp;mut self,
        context: &amp;EffectContext,
        effect: &amp;[u8],
    ) -&gt; Result&lt;ExecutionResult, Self::Error&gt;;

    /// Handles a call from another application.
    async fn handle_application_call(
        &amp;mut self,
        context: &amp;CalleeContext,
        argument: &amp;[u8],
        forwarded_sessions: Vec&lt;SessionId&gt;,
    ) -&gt; Result&lt;ApplicationCallResult, Self::Error&gt;;

    /// Handles a call into a session created by this application.
    async fn handle_session_call(
        &amp;mut self,
        context: &amp;CalleeContext,
        session: Session,
        argument: &amp;[u8],
        forwarded_sessions: Vec&lt;SessionId&gt;,
    ) -&gt; Result&lt;SessionCallResult, Self::Error&gt;;
}
<span class="boring">}</span></code></pre></pre>
<p>There's quite a bit going on here, so let's break it down and take one method at a time.</p>
<p>For this application, we'll be using the <code>initialize</code> and <code>execute_operation</code> command.</p>
<h3 id="initialising-our-application"><a class="header" href="#initialising-our-application">Initialising our Application</a></h3>
<p>The first thing we need to do is initialize our application by using <code>Contract::initialize</code>.</p>
<p><code>Contract::initialize</code> is only called once when the application is created and only on the microchain that 
created the application. </p>
<p>Deployment on other microchains will use the <code>Default</code> implementation of the application state if 
<code>SimpleStateStorage</code> is used, or the Default value of all sub-views in the state if the <code>ViewStateStorage</code> is used.</p>
<p>For our <code>Counter</code> application, we'll want to initialize the state of the application to an arbitrary number that can
be specified on application creation using its initialization parameters:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    async fn initialize(
        &amp;mut self,
        _context: &amp;OperationContext,
        argument: &amp;[u8],
    ) -&gt; Result&lt;ExecutionResult, Self::Error&gt; {
        self.value.set(bcs::from_bytes(argument)?);
        Ok(ExecutionResult::default())
    }
<span class="boring">}</span></code></pre></pre>
<blockquote>
<p>Note: We're using the <a href="https://crates.io/crates/bcs">bcs</a> crate for serializing and deserializing values.
This is a recurring theme throughout the Linera project. Using BCS for serialization is important
because it enforces canonical serialization, meaning that every value of a given type has a <strong>single
valid representation</strong>. This is especially important when computing hashes, signatures and certificates.</p>
</blockquote>
<h3 id="implementing-the-increment-operation"><a class="header" href="#implementing-the-increment-operation">Implementing the Increment Operation</a></h3>
<p>Now that we have our counter's state and a way to initialize it to any value we would like, a way to increment
our counter's value. Changes made by block proposers to application states are broadly called 'operations'.</p>
<p>To create a new operation, we need to use the method <code>Contract::execute_operation</code>. In the counter's case,
it will be receiving a <code>u128</code>  which needs to be deserialized and the used to increment the couter state like so:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>    async fn execute_operation(
        &amp;mut self,
        _context: &amp;OperationContext,
        operation: &amp;[u8],
    ) -&gt; Result&lt;ExecutionResult, Self::Error&gt; {
        let increment: u128 = bcs::from_bytes(operation)?;
        let value = self.value.get_mut();
        *value += increment;
        Ok(ExecutionResult::default())
    }
<span class="boring">}</span></code></pre></pre>
<h2 id="creating-the-service"><a class="header" href="#creating-the-service">Creating the Service</a></h2>
<p>The <code>Service</code> is the second component of your Linera application. It is compiled
into a separate Bytecode from the contract and is run independently. It is not
metered (meaning that querying an application's service does not consume gas),
and can be thought of as a read-only view into your application.</p>
<p>Your application state can be arbitrarily complex, and most of the time you
don't
want to expose this state in its entirety to those who would like to interact
with your app. Instead, you might prefer to define a distinct set of queries
that
can be made against your application.</p>
<p>The <code>Service</code> trait is how you define the interface into your application.
The <code>Service</code> trait is defined as follows:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[async_trait]
pub trait Service {
    /// Message reports for service execution errors.
    type Error: Error;
    /// The desired storage backend to use to read the application's state.
    type Storage;

    /// Executes a read-only query on the state of this application.
    async fn query_application(
        self: Arc&lt;Self&gt;,
        context: &amp;QueryContext,
        argument: &amp;[u8],
    ) -&gt; Result&lt;Vec&lt;u8&gt;, Self::Error&gt;;
}
<span class="boring">}</span></code></pre></pre>
<p>Let's implement <code>Service</code> for our counter application.</p>
<p>First, we want to generate the necessary boilerplate for implementing the
service WIT interface, export the necessary resource types and functions so that
the host (the process running the bytecode) can call the service. Happilly,
there is a macro to perform this code generation, so simply add the following
to <code>service.rs</code>:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>linera_sdk::service!(Counter&lt;ReadOnlyViewStorageContext&gt;);
<span class="boring">}</span></code></pre></pre>
<p>Notice that the Counter context is <code>ReadOnlyViewStorageContext</code>. This ensures
that the host has a read-only view on the application's state.</p>
<p>Next, we need to implement the <code>Service</code> for <code>Counter</code>. To do this we need to
define <code>Service</code>'s associated types and implement <code>query_application</code>, as well
as define the <code>Error</code> type:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>#[async_trait]
impl&lt;C&gt; Service for Counter&lt;C&gt;
    where
        C: Context + Send + Sync + Clone + 'static,
        ViewError: From&lt;C::Error&gt;,
{
    type Error = Error;
    type Storage = ViewStateStorage&lt;Self&gt;;

    async fn query_application(
        self: Arc&lt;Self&gt;,
        _context: &amp;QueryContext,
        argument: &amp;[u8],
    ) -&gt; Result&lt;Vec&lt;u8&gt;, Self::Error&gt; {
        let graphql_request: async_graphql::Request = serde_json::from_slice(argument).map_err(|_| Error::InvalidQuery)?;
        let schema = Schema::build(self.clone(), MutationRoot {}, EmptySubscription).finish();
        let res = schema.execute(graphql_request).await;
        Ok(serde_json::to_vec(&amp;res).unwrap())
    }
}

/// An error that can occur during the contract execution.
#[derive(Debug, Error, Eq, PartialEq)]
pub enum Error {
    /// Invalid query argument; Counter application only supports a single (empty) query.
    #[error(
    &quot;Invalid query argument; Counter application only supports JSON encoded GraphQL queries&quot;
    )]
    InvalidQuery,
}
<span class="boring">}</span></code></pre></pre>
<p>Notice, that the input <code>argument</code> and returned <code>Vec&lt;u8&gt;</code> are both simple byte
arrays. Therefore, the inputs and outputs made to the service can be effectively
arbitrary. In our case, we'll be using the existing Linera GraphQL
infrastructure to make our app easy for a graphical front end to consume.</p>
<p>The final piece of the the service is the <code>MutationRoot</code>. This is a convencience
schema which is used for GraphQL introspection queries:</p>
<pre><pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>struct MutationRoot;

#[Object]
impl MutationRoot {
    #[allow(unused)]
    async fn execute_operation(&amp;self, operation: CounterOperation) -&gt; Vec&lt;u8&gt; {
        bcs::to_bytes(&amp;operation).unwrap()
    }
}
<span class="boring">}</span></code></pre></pre>
<p>We haven't included the imports in the above code; they are left as an
exercise to the reader. If you want the full source code and associated tests
check out
the <a href="https://github.com/linera-io/linera-protocol/blob/main/linera-examples/counter-graphql/src/service.rs">examples section</a>
on GitHub.</p>
<h2 id="deploying-your-application"><a class="header" href="#deploying-your-application">Deploying your Application</a></h2>
<p>To deploy your application, you first need to navigate to <code>target/debug</code> where the <code>linera</code> binary is located.</p>
<ol>
<li>The location of the contract bytecode</li>
<li>The location of the service bytecode</li>
<li>The hex encoded initialization arguments</li>
</ol>
<pre><code class="language-bash">./linera --storage rocksdb:client.db --wallet wallet.json --genesis genesis.json --max-pending-messages 10000 publish_and_create \
    ../../linera-examples/target/wasm32-unknown-unknown/release/my_counter_contract.wasm \
    ../../linera-examples/target/wasm32-unknown-unknown/release/my_counter_service.wasm \
    00
</code></pre>
<h2 id="building-a-front-end-for-your-application"><a class="header" href="#building-a-front-end-for-your-application">Building a Front End for your Application</a></h2>
<p>// todo</p>
<h2 id="running-your-web-3-app"><a class="header" href="#running-your-web-3-app">Running your Web 3 App</a></h2>
<p>// todo</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../core_concepts/applications.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next" href="../advanced.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../core_concepts/applications.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next" href="../advanced.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
